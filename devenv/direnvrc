# shellcheck shell=bash
# adapted from https://github.com/nix-community/nix-direnv/blob/master/direnvrc

REQUIRED_DIRENV_VERSION="2.21.3"

_nix_direnv_preflight () {
  if [[ -z "$direnv" ]]; then
    printf '%s\n' "\$direnv environment variable was not defined. Was this script run inside direnv?"
    exit 1
  fi

  if [[ -z ${DEVENV_BIN:-} ]]; then
    DEVENV_BIN=$(command -v devenv)
    if [[ -z "${DEVENV_BIN}" ]]; then
      log_error "command not found: devenv, see https://devenv.sh/getting-started/"
      exit 1
    fi
  fi

  if ! has direnv_version || ! direnv_version "$REQUIRED_DIRENV_VERSION" 2>/dev/null; then
    log_error "base direnv version is older than the required v$REQUIRED_DIRENV_VERSION."
    exit 1
  fi

  local layout_dir
  layout_dir=$(direnv_layout_dir)

  if [[ ! -d "$layout_dir" ]]; then
    mkdir -p "$layout_dir"
  fi

  export DEVENV_DIRENVRC_VERSION=2
  export DEVENV_DIRENVRC_ROLLING_UPGRADE=0
}

_nix_export_or_unset() {
  local key=$1 value=$2
  if [[ "$value" == __UNSET__ ]]; then
    unset "$key"
  else
    export "$key=$value"
  fi
}

_nix_import_env() {
  local env=$1

  # Note which environments are active, but make sure we don't repeat them
  if [[ ! "''${DIRENV_ACTIVE-}" =~ (^|:)"$PWD"(:|$) ]]; then
    export DIRENV_ACTIVE="$PWD:''${DIRENV_ACTIVE-}"
  fi

  local old_nix_build_top=${NIX_BUILD_TOP:-__UNSET__}
  local old_tmp=${TMP:-__UNSET__}
  local old_tmpdir=${TMPDIR:-__UNSET__}
  local old_temp=${TEMP:-__UNSET__}
  local old_tempdir=${TEMPDIR:-__UNSET__}
  local old_xdg_data_dirs=${XDG_DATA_DIRS:-}
  eval "$env"
  # `nix print-dev-env` will create a temporary directory and use it as TMPDIR
  # We cannot rely on this directory being available at all times,
  # as it may be garbage collected.
  # Instead - just remove it immediately.
  # Use recursive & force as it may not be empty.
  if [[ -n "${NIX_BUILD_TOP+x}" && "$NIX_BUILD_TOP" == */nix-shell.* && -d "$NIX_BUILD_TOP" ]]; then
    rm -rf "$NIX_BUILD_TOP"
  fi

  _nix_export_or_unset NIX_BUILD_TOP "$old_nix_build_top"
  _nix_export_or_unset TMP "$old_tmp"
  _nix_export_or_unset TMPDIR "$old_tmpdir"
  _nix_export_or_unset TEMP "$old_temp"
  _nix_export_or_unset TEMPDIR "$old_tempdir"
  local new_xdg_data_dirs=${XDG_DATA_DIRS:-}
  export XDG_DATA_DIRS=
  local IFS=:
  for dir in $new_xdg_data_dirs${old_xdg_data_dirs:+:}$old_xdg_data_dirs; do
    dir="${dir%/}" # remove trailing slashes
    if [[ :$XDG_DATA_DIRS: = *:$dir:* ]]; then
      continue # already present, skip
    fi
    XDG_DATA_DIRS="$XDG_DATA_DIRS${XDG_DATA_DIRS:+:}$dir"
  done
}

_devenv_watches() {
  local path=$1
  local -n _watches=$2
  if [[ -f "$path" ]]; then
    while IFS= read -r file; do
      file=$(printf "$file")
      _watches+=("$file")
    done < "$path"
  fi
}

use_devenv() {
  _nix_direnv_preflight

  export DEVENV_CMDLINE="$*"

  local devenv_cmd=("${DEVENV_BIN}")
  if (( $# > 0 )); then
    devenv_cmd+=("$@")
  fi

  # Watch default files even if build fails (so fixes trigger reload)
  watch_file ".envrc" "$HOME/.direnvrc" "$HOME/.config/direnv/direnvrc"
  watch_file "devenv.nix" "devenv.lock" "devenv.yaml" "devenv.local.nix" "devenv.local.yaml"

  # Keep watching the previous dependency set so edits can recover from failed evals.
  # DEVENV_DOTFILE is available from the previously-loaded environment.
  local previous_watches=()
  if [[ -n "${DEVENV_DOTFILE:-}" ]]; then
    _devenv_watches "$DEVENV_DOTFILE/input-paths.txt" previous_watches
  fi
  if [[ ${#previous_watches[@]} -gt 0 ]]; then
    watch_file "${previous_watches[@]}"
  fi

  local env
  if ! env=$("${devenv_cmd[@]}" direnv-export); then
    log_error "failed to build the devenv environment. see above."
    exit 0
  fi

  # Import environment (sets DEVENV_DOTFILE, DEVENV_ROOT, etc. from Nix)
  _nix_import_env "$env"

  # Watch input files discovered during evaluation
  local env_watches=()
  _devenv_watches "$DEVENV_DOTFILE/input-paths.txt" env_watches
  if [[ ${#env_watches[@]} -gt 0 ]]; then
    watch_file "${env_watches[@]}"
  fi
}
