name: "Debug GC Crash"

on:
  push:
  workflow_dispatch:

jobs:
  debug-gc-crash:
    name: Debug GC crash (x86_64-linux)
    runs-on: ["self-hosted", "linux", "X64"]

    steps:
      - uses: actions/checkout@v5

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Configure Cachix
        uses: cachix/cachix-action@v16
        with:
          name: devenv
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Capture environment info
        run: |
          echo "=== System Info ==="
          uname -a
          cat /proc/version
          echo "=== Memory Info ==="
          free -h
          cat /proc/meminfo | head -30
          echo "=== VM Settings ==="
          cat /proc/sys/vm/overcommit_memory || true
          cat /proc/sys/vm/overcommit_ratio || true
          cat /proc/sys/kernel/randomize_va_space || true
          echo "=== Transparent Huge Pages ==="
          cat /sys/kernel/mm/transparent_hugepage/enabled || true
          echo "=== CPU Info ==="
          cat /proc/cpuinfo | grep -E "model name|flags" | head -4

      - name: Build devenv
        id: build-devenv
        run: |
          devenv_path=$(nix build -L --print-out-paths .#devenv)
          echo "path=$devenv_path" >> $GITHUB_OUTPUT

      # Check current core dump settings (read-only)
      - name: Check core dump settings
        run: |
          echo "=== Current core pattern ==="
          cat /proc/sys/kernel/core_pattern || true
          echo "=== ulimit ==="
          ulimit -a || true

      # Run tests many times to catch crash
      - name: Run tests (50 iterations)
        continue-on-error: true
        env:
          RUST_BACKTRACE: full
          # Boehm GC debug options
          GC_PRINT_STATS: 1
          GC_PRINT_VERBOSE_STATS: 1
        run: |
          echo "=== Running tests 50 times to catch crash ==="

          # Build test binaries first
          ${{ steps.build-devenv.outputs.path }}/bin/devenv shell -- cargo test --all-features --no-run 2>&1 | tail -10

          for i in $(seq 1 50); do
            echo "=== Iteration $i ==="
            ${{ steps.build-devenv.outputs.path }}/bin/devenv shell -- \
              cargo nextest run --all-features -j 1 2>&1 || {
                exit_code=$?
                echo "!!! CRASH on iteration $i with exit code $exit_code !!!"
                echo "Exit code: $exit_code"
                # Signal 11 = SIGSEGV, Signal 6 = SIGABRT
                if [ $exit_code -gt 128 ]; then
                  signal=$((exit_code - 128))
                  echo "Killed by signal: $signal"
                fi
                exit 1
              }
            echo "Iteration $i passed"
          done
          echo "No crash after 50 iterations"

      - name: Summary
        run: |
          echo "=== Results ==="
          echo "Check logs above for crash replay"
