name: "Debug GC Crash"

on:
  push:
  workflow_dispatch:

jobs:
  debug-gc-crash:
    name: Debug GC crash (x86_64-linux)
    runs-on: ["self-hosted", "linux", "X64"]

    steps:
      - uses: actions/checkout@v5

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Configure Cachix
        uses: cachix/cachix-action@v16
        with:
          name: devenv
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Capture environment info
        run: |
          echo "=== System Info ==="
          uname -a
          cat /proc/version
          echo "=== Memory Info ==="
          free -h
          cat /proc/meminfo | head -30
          echo "=== VM Settings ==="
          cat /proc/sys/vm/overcommit_memory || true
          cat /proc/sys/vm/overcommit_ratio || true
          cat /proc/sys/kernel/randomize_va_space || true
          echo "=== Transparent Huge Pages ==="
          cat /sys/kernel/mm/transparent_hugepage/enabled || true
          echo "=== CPU Info ==="
          cat /proc/cpuinfo | grep -E "model name|flags" | head -4

      - name: Build devenv
        id: build-devenv
        run: |
          devenv_path=$(nix build -L --print-out-paths .#devenv)
          echo "path=$devenv_path" >> $GITHUB_OUTPUT

      # Check current core dump settings (read-only)
      - name: Check core dump settings
        run: |
          echo "=== Current core pattern ==="
          cat /proc/sys/kernel/core_pattern || true
          echo "=== ulimit ==="
          ulimit -a || true

      # Get backtrace with GDB on crash - run multiple times
      - name: Test with GDB backtrace (20 iterations)
        continue-on-error: true
        env:
          RUST_BACKTRACE: full
        run: |
          echo "=== Running with GDB to get backtrace (20 iterations) ==="
          ${{ steps.build-devenv.outputs.path }}/bin/devenv shell -- bash -c '
            # Build all test binaries
            cargo test --all-features --no-run 2>&1 | tail -10

            # Find test binaries
            DEVENV_LIB=$(cargo test -p devenv --lib --features integration-tests --no-run --message-format=json 2>/dev/null | jq -r "select(.executable != null) | .executable" | grep "devenv-" | head -1)
            BACKEND_LIB=$(cargo test -p devenv-nix-backend --lib --no-run --message-format=json 2>/dev/null | jq -r "select(.executable != null) | .executable" | head -1)

            echo "Test binaries:"
            echo "  devenv lib: $DEVENV_LIB"
            echo "  backend lib: $BACKEND_LIB"

            # Run tests in a loop under GDB
            for i in $(seq 1 20); do
              echo "=== Iteration $i/20 ==="

              # Alternate between different tests that have crashed
              if [ $((i % 2)) -eq 0 ]; then
                TEST_BIN="$DEVENV_LIB"
                TEST_NAME="test_fetch_packages_live"
              else
                TEST_BIN="$BACKEND_LIB"
                TEST_NAME="test_full_workflow"
              fi

              echo "Running $TEST_NAME..."

              gdb -batch \
                -ex "set confirm off" \
                -ex "handle SIGSEGV stop print" \
                -ex "handle SIGABRT stop print" \
                -ex "run $TEST_NAME --nocapture" \
                -ex "bt full" \
                -ex "info registers" \
                -ex "info threads" \
                -ex "thread apply all bt full" \
                "$TEST_BIN" 2>&1 | tee /tmp/gdb_output_$i.txt

              # Check if we got a signal
              if grep -q "Program received signal" /tmp/gdb_output_$i.txt; then
                echo "!!! CRASH DETECTED on iteration $i !!!"
                cat /tmp/gdb_output_$i.txt
                exit 0
              fi
            done
            echo "No crash after 20 iterations"
          '

      # Run full test suite like CI (with nextest)
      - name: Full test suite (nextest)
        id: baseline
        continue-on-error: true
        env:
          RUST_BACKTRACE: full
        run: |
          echo "=== Full test suite with nextest (like CI) ==="
          ${{ steps.build-devenv.outputs.path }}/bin/devenv shell -- \
            cargo nextest run --all-features -j 1 2>&1 || {
              echo "CRASHED with exit code $?"
              exit 1
            }

      - name: Summary
        run: |
          echo "=== Results ==="
          echo "Full nextest suite: ${{ steps.baseline.outcome }}"
